---
export interface Props {
	title: string;
	examId: string;
}

const {title, examId} = Astro.props;
---

<div class='exam-content'>
	<h1>{title}</h1>
	<form id='examForm'>
		<slot />
		<button type='button' id='checkAnswers' class='btn-primary'>Vérifier les réponses</button>
	</form>

	<div id='results'></div>
</div>

<script define:vars={{examId}}>
	// Cette fonction sera appelée avec les réponses correctes fournies par le fichier de données d'examen
	function setupExamValidation(correctRadioAnswers, correctCheckboxAnswers) {
		document.addEventListener("DOMContentLoaded", function () {
			const checkAnswersButton = document.getElementById("checkAnswers");
			if (checkAnswersButton) {
				checkAnswersButton.addEventListener("click", function () {
					// Ajouter un effet lors du clic
					checkAnswersButton.classList.add("clicked");
					setTimeout(() => {
						checkAnswersButton.classList.remove("clicked");
					}, 300);

					let score = 0;
					let totalQuestions = Object.keys(correctRadioAnswers).length + Object.keys(correctCheckboxAnswers).length;
					let resultsHtml = `<div class="results-header"><h2>Résultats</h2><p class="results-summary"></p></div><div class="results-details">`;

					// Vérifier les questions à choix unique (radio)
					for (let q in correctRadioAnswers) {
						const selected = document.querySelector(`input[name="${q}"]:checked`);
						const questionDiv = document.getElementById(q);

						if (selected) {
							if (selected.value === correctRadioAnswers[q]) {
								score++;
								// Style pour réponse correcte
								if (questionDiv) {
									questionDiv.classList.add("correct-answer");
								}
								resultsHtml += `<div class="result-item correct">
									<div class="result-icon">✓</div>
									<div class="result-content">
										<p>Question ${q.substring(1)}: <span>Correct!</span></p>
									</div>
								</div>`;
							} else {
								// Style pour réponse incorrecte
								if (questionDiv) {
									questionDiv.classList.add("incorrect-answer");
								}
								resultsHtml += `<div class="result-item incorrect">
									<div class="result-icon">✕</div>
									<div class="result-content">
										<p>Question ${q.substring(1)}: <span>Incorrect</span></p>
									</div>
								</div>`;
							}
						} else {
							// Style pour question non répondue
							if (questionDiv) {
								questionDiv.classList.add("unanswered");
							}
							resultsHtml += `<div class="result-item unanswered">
								<div class="result-icon">!</div>
								<div class="result-content">
									<p>Question ${q.substring(1)}: <span>Non répondu</span></p>
								</div>
							</div>`;
						}

						// Afficher l'explication
						const explanation = document.getElementById(`explain${q.substring(1)}`);
						if (explanation) {
							explanation.classList.add("visible");
						}
					}

					// Vérifier les questions à choix multiples (checkbox)
					for (let q in correctCheckboxAnswers) {
						const questionDiv = document.getElementById(q);
						const selectedCheckboxes = document.querySelectorAll(`input[name="${q}"]:checked`);
						const selectedValues = Array.from(selectedCheckboxes).map((cb) => cb.value);

						// Vérifier si les réponses sélectionnées correspondent exactement aux réponses correctes
						const correctForThisQuestion = correctCheckboxAnswers[q];
						const isCorrect = selectedValues.length === correctForThisQuestion.length && selectedValues.every((val) => correctForThisQuestion.includes(val));

						if (selectedValues.length > 0) {
							if (isCorrect) {
								score++;
								// Style pour réponse correcte
								if (questionDiv) {
									questionDiv.classList.add("correct-answer");
								}
								resultsHtml += `<div class="result-item correct">
									<div class="result-icon">✓</div>
									<div class="result-content">
										<p>Question ${q.substring(1)}: <span>Correct!</span></p>
									</div>
								</div>`;
							} else {
								// Style pour réponse incorrecte
								if (questionDiv) {
									questionDiv.classList.add("incorrect-answer");
								}
								resultsHtml += `<div class="result-item incorrect">
									<div class="result-icon">✕</div>
									<div class="result-content">
										<p>Question ${q.substring(1)}: <span>Incorrect</span></p>
									</div>
								</div>`;
							}
						} else {
							// Style pour question non répondue
							if (questionDiv) {
								questionDiv.classList.add("unanswered");
							}
							resultsHtml += `<div class="result-item unanswered">
								<div class="result-icon">!</div>
								<div class="result-content">
									<p>Question ${q.substring(1)}: <span>Non répondu</span></p>
								</div>
							</div>`;
						}

						// Afficher l'explication
						const explanation = document.getElementById(`explain${q.substring(1)}`);
						if (explanation) {
							explanation.classList.add("visible");
						}
					}

					resultsHtml += `</div>`;

					const resultsDiv = document.getElementById("results");
					if (resultsDiv) {
						resultsDiv.innerHTML = resultsHtml;
						resultsDiv.style.display = "block";

						// Update score summary
						const percentage = Math.round((score / totalQuestions) * 100);
						const resultsSummary = resultsDiv.querySelector(".results-summary");
						if (resultsSummary) {
							resultsSummary.innerHTML = `<span class="score-number">${score}/${totalQuestions}</span> <span class="score-percentage">(${percentage}%)</span>`;

							// Add score class based on result
							if (percentage >= 80) {
								resultsSummary.classList.add("high-score");
							} else if (percentage >= 60) {
								resultsSummary.classList.add("medium-score");
							} else {
								resultsSummary.classList.add("low-score");
							}
						}

						// Add animation class for entrance
						resultsDiv.classList.add("results-visible");

						// Défiler jusqu'aux résultats avec une animation fluide
						setTimeout(() => {
							resultsDiv.scrollIntoView({behavior: "smooth"});
						}, 200);
					}
				});
			}
		});
	}

	// Importer dynamiquement les réponses correctes pour cet examen spécifique
	import(`/src/data/exams/exam${examId}.js`)
		.then((module) => {
			setupExamValidation(module.correctRadioAnswers, module.correctCheckboxAnswers);
		})
		.catch((error) => {
			console.error(`Erreur lors du chargement des réponses pour l'examen ${examId}:`, error);
		});
</script>

<style>
	.exam-content {
		background: white;
		border-radius: var(--border-radius);
		box-shadow: var(--shadow);
		padding: 2.5rem;
		max-width: 800px;
		margin: 0 auto;
		position: relative;
		animation: fadeIn 0.6s ease;
	}

	.exam-content::before {
		content: "";
		position: absolute;
		top: 0;
		left: 0;
		width: 4px;
		height: 100%;
		background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
		border-radius: var(--border-radius) 0 0 var(--border-radius);
	}

	h1 {
		margin-top: 0;
		margin-bottom: 2rem;
		color: var(--text-color);
		border-bottom: 1px solid rgba(0, 0, 0, 0.08);
		padding-bottom: 1rem;
		font-size: 1.8rem;
		position: relative;
	}

	h1::after {
		content: "";
		position: absolute;
		bottom: -1px;
		left: 0;
		width: 80px;
		height: 3px;
		background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
		border-radius: 3px;
	}

	.btn-primary {
		background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
		color: white;
		border: none;
		padding: 0.75rem 1.5rem;
		border-radius: var(--border-radius);
		cursor: pointer;
		font-size: 1rem;
		font-weight: 500;
		margin-top: 2rem;
		transition: all var(--transition-normal);
		position: relative;
		overflow: hidden;
		box-shadow: var(--shadow-sm);
	}

	.btn-primary:hover {
		box-shadow: var(--shadow-md);
		transform: translateY(-2px);
	}

	.clicked {
		transform: scale(0.95) !important;
		box-shadow: var(--shadow-sm) !important;
	}

	#results {
		margin-top: 2.5rem;
		border-radius: var(--border-radius);
		background-color: white;
		overflow: hidden;
		display: none;
		box-shadow: var(--shadow);
		border: 1px solid rgba(0, 0, 0, 0.05);
		opacity: 0;
		transform: translateY(10px);
		transition:
			opacity 0.4s ease,
			transform 0.4s ease;
	}

	.results-visible {
		opacity: 1 !important;
		transform: translateY(0) !important;
	}

	.results-header {
		padding: 1.5rem;
		border-bottom: 1px solid rgba(0, 0, 0, 0.08);
		display: flex;
		align-items: center;
		justify-content: space-between;
	}

	.results-header h2 {
		margin: 0;
		font-size: 1.5rem;
		color: var(--text-color);
	}

	.results-summary {
		font-size: 1.2rem;
		font-weight: 600;
		margin: 0;
	}

	.score-number {
		font-size: 1.4rem;
	}

	.high-score {
		color: var(--success-color);
	}

	.medium-score {
		color: var(--warning-color);
	}

	.low-score {
		color: var(--error-color);
	}

	.results-details {
		padding: 1rem;
	}

	.result-item {
		display: flex;
		align-items: center;
		padding: 0.75rem;
		border-radius: var(--border-radius-sm);
		margin-bottom: 0.5rem;
		transition: transform 0.2s ease;
	}

	.result-item:hover {
		transform: translateX(3px);
	}

	.result-item.correct {
		background-color: rgba(16, 185, 129, 0.1);
	}

	.result-item.incorrect {
		background-color: rgba(239, 68, 68, 0.1);
	}

	.result-item.unanswered {
		background-color: rgba(245, 158, 11, 0.1);
	}

	.result-icon {
		width: 28px;
		height: 28px;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		margin-right: 0.75rem;
		font-weight: bold;
	}

	.correct .result-icon {
		background-color: var(--success-color);
		color: white;
	}

	.incorrect .result-icon {
		background-color: var(--error-color);
		color: white;
	}

	.unanswered .result-icon {
		background-color: var(--warning-color);
		color: white;
	}

	.result-content {
		flex: 1;
	}

	.result-content p {
		margin: 0;
	}

	.result-content span {
		font-weight: 600;
	}

	@keyframes fadeIn {
		from {
			opacity: 0;
			transform: translateY(10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	@media (max-width: 768px) {
		.exam-content {
			padding: 1.5rem;
		}

		.results-header {
			flex-direction: column;
			align-items: flex-start;
		}

		.results-summary {
			margin-top: 0.5rem;
		}
	}

	:global(.correct-answer) {
		border-left: 4px solid var(--success-color) !important;
		box-shadow: 0 0 15px rgba(16, 185, 129, 0.1) !important;
		animation: pulse-success 1s ease;
	}

	:global(.incorrect-answer) {
		border-left: 4px solid var(--error-color) !important;
		box-shadow: 0 0 15px rgba(239, 68, 68, 0.1) !important;
		animation: pulse-error 1s ease;
	}

	:global(.unanswered) {
		border-left: 4px solid var(--warning-color) !important;
		box-shadow: 0 0 15px rgba(245, 158, 11, 0.1) !important;
		animation: pulse-warning 1s ease;
	}

	:global(.explanation.visible) {
		display: block;
		animation: slideDown 0.4s ease-out;
	}

	@keyframes pulse-success {
		0%,
		100% {
			box-shadow: 0 0 15px rgba(16, 185, 129, 0.1);
		}
		50% {
			box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
		}
	}

	@keyframes pulse-error {
		0%,
		100% {
			box-shadow: 0 0 15px rgba(239, 68, 68, 0.1);
		}
		50% {
			box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
		}
	}

	@keyframes pulse-warning {
		0%,
		100% {
			box-shadow: 0 0 15px rgba(245, 158, 11, 0.1);
		}
		50% {
			box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
		}
	}

	@keyframes slideDown {
		from {
			opacity: 0;
			transform: translateY(-10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
</style>
